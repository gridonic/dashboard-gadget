<html>
<head>
    <title>Dashboard Gadget: Interface</title>

    <link rel="stylesheet" type="text/css" href="/assets/css/styles.css">
</head>
<body>
    <h1>Interaktives Dashboard-Gadget: Image-Helper</h1>

    <section>
        <canvas id="display" width="160" height="160" class="display"></canvas>

        <canvas id="display-output" width="160" height="160" class="display -second"></canvas>

        <div style="margin-top: 20px;">
            Upload image
            <input type="file" id="btn-image-upload">
            <button id="btn-convert">Start / Convert</button>
        </div>

        <div style="margin-top: 20px;">
            <div id="output" style="width: 500px; font-family: monospace;">Output...</div>
        </div>
    </section>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        var start = document.getElementById('btn-convert');
        var upload = document.getElementById('btn-image-upload');
        var output = document.getElementById('output');
        var canvas = document.getElementById("display");
        var context = canvas.getContext("2d");
        var canvasOutput = document.getElementById("display-output");
        var contextOutput = canvasOutput.getContext("2d");

        var image = new Image();
        var fr = new FileReader();

        generateOutput = function () {

            var outputString = '"" + <br>';
            var outputStringCanvas = '';
            var oneLine = "";
            var char = 0;
            var data;

            for (var i = 0; i < 160; i++) {
                for (var j = 0; j < 160; j++) {
                    char = '0';
                    data = context.getImageData(j,i,1,1).data;
                    if (data[0] === 0 && data[1] === 0 && data[2] === 0 && data[3] === 255) {
                        char = '1';
                    } else if (data[0] < 85 && data[1] < 85 && data[2] < 85 && data[3] === 255) {
                        char = '1';
                    } else if (data[0] < 255 && data[1] < 255 && data[2] < 255 && data[3] === 255) {
//                        console.log(data);
                    }
                    oneLine += char;
                    outputStringCanvas += char;
                }

                outputString += '"' + oneLine + '" + <br>';
                oneLine = "";
            }

            outputString += '"";';
            output.style.fontSize = 5;
            output.innerHTML = outputString;

            // now draw to the output-canvas
            contextOutput.fillStyle = "#ffffff";
            contextOutput.fillRect(0, 0, 160, 160);

            contextOutput.fillStyle = "#000000";
            var draw = outputStringCanvas.split("");
            var x = 0;
            for (var i = 0; i < 160; i++) {
                for (var j = 0; j < 160; j++) {
                    if (draw[x] === '1') {
                        contextOutput.fillRect(j, i, 1, 1);
                    }
                    x++;
                }
            }
         };

        loadImageToCanvas = function () {
            image.src = fr.result;
            context.drawImage(image, 0, 0);
            generateOutput();
        };

        start.onclick = function () {

            output.innerHTML = 'Output...';

            if (upload.files.length > 0) {
                var file = upload.files[0];

                if (file.type !== 'image/png') {
                    output.innerHTML = 'Please upload a PNG!';
                    return;
                }
                console.log(file);

                fr.onload = loadImageToCanvas;   // onload fires after reading is complete
                fr.readAsDataURL(file);

            } else {
                output.innerHTML = 'Please select a file first.';
            }
        }

    </script>

</body>
</html>